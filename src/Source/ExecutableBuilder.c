#include "ExecutableBuilder.h"

void BuildExecutable(ASTNode *node)
{

    const uint8_t Hello_World_Program[] = 
    {
        0xB8, 0x04, 0x00, 0x00, 0x00,
        0xBB, 0x01, 0x00, 0x00, 0x00,
        0xB9, 0x76, 0x80, 0x04, 0x08,
        0xBA, 0x0E, 0x00, 0x00, 0x00,
        0xCD, 0x80,
    };

    const uint8_t program_segment_end[] = 
    {
        0xB8, 0x01, 0x00, 0x00, 0x00,
        0xBB, 0x00, 0x00, 0x00, 0x00,
        0xCD, 0x80,
    };

    const uint8_t hello_world_string[] =
    {
        'H', 'e', 'l', 'l', 'o', ',', ' ', 'W', 'o', 'r', 'l', 'd', '!', '\n'
    };

    // Create Code Here



    uint8_t elf_header[] = 
    {
        0x7F, 0x45, 0x4C, 0x46,
        0x01, 
            0x01, 
                0x01,
                    0x00,
        0x00,
            0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        
        0x02, 0x00,
                0x03, 0x00,
        0x01, 0x00, 0x00, 0x00,
        
        0x54, 0x80, 0x04, 0x08,
        0x34, 0x00, 0x00, 0x00,

        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,

        0x34, 0x00,
                0x20, 0x00,
        0x01, 0x00,
                0x28, 0x00,
        
        0x00, 0x00,
                0x00, 0x00
    };

    uint8_t program_header[] = 
    {
        0x01, 0x00, 0x00, 0x00,
        0x54, 0x00, 0x00, 0x00,
        0x54, 0x80, 0x04, 0x08,
        0x00, 0x00, 0x00, 0x00,
        sizeof(Hello_World_Program) + sizeof(program_segment_end) + sizeof(hello_world_string), 0x00, 0x00, 0x00, // code size
        sizeof(Hello_World_Program) + sizeof(program_segment_end) + sizeof(hello_world_string), 0x00, 0x00, 0x00, // code size
        0x05, 0x00, 0x00, 0x00,
        0x00, 0x10, 0x00, 0x00
    };

    FILE* file = fopen("code", "wb");
    if (!file)
    {
        perror("Failed to open file!");
    }

    fwrite(&elf_header, sizeof(elf_header), 1, file);
    fwrite(&program_header, sizeof(program_header), 1, file);

    fwrite(Hello_World_Program, sizeof(Hello_World_Program), 1, file);
    fwrite(program_segment_end, sizeof(uint8_t) * 12, 1, file);
    fwrite(hello_world_string, sizeof(hello_world_string), 1, file);

    fclose(file);
    printf("Successfully created executable!\n");
}